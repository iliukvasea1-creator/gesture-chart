<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>iPhone MediaPipe FINAL FIX</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  overflow: hidden;
}

#status {
  position: fixed;
  top: 10px;
  left: 10px;
  color: #00ff88;
  font-family: monospace;
  z-index: 10;
}

video {
  position: fixed;
  right: 10px;
  bottom: 10px;
  width: 160px;
  opacity: 0.35;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>

<body>

<div id="status">TAP TO START</div>
<video id="video" playsinline muted></video>

<script>
const status = document.getElementById('status')
const video  = document.getElementById('video')

let hands
let running = false

// ===== START CAMERA =====
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user' }
    })
    video.srcObject = stream

    // CRITICAL FOR iOS
    video.onloadedmetadata = async () => {
      await video.play()
      status.innerText = 'VIDEO READY'
      initHands()
    }

  } catch (e) {
    status.innerText = 'CAMERA ERROR'
    alert(e.name + ': ' + e.message)
  }
}

// ===== INIT MEDIAPIPE =====
function initHands() {
  hands = new Hands({
    locateFile: f =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  })

  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 0,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  })

  hands.onResults(res => {
    if (!res.multiHandLandmarks) {
      status.innerText = 'NO HAND'
      return
    }

    status.innerText = 'âœ‹ HAND DETECTED'

    const lm = res.multiHandLandmarks[0]
    const d = Math.hypot(
      lm[4].x - lm[8].x,
      lm[4].y - lm[8].y
    )

    if (d < 0.07) {
      status.innerText = 'ðŸ¤ PINCH'
    }
  })

  running = true
  loop()
}

// ===== FRAME LOOP =====
async function loop() {
  if (!running) return
  await hands.send({ image: video })
  requestAnimationFrame(loop)
}

// ===== USER GESTURE =====
document.body.addEventListener('click', () => {
  if (!running) {
    status.innerText = 'STARTINGâ€¦'
    startCamera()
  }
}, { once: true })
</script>

</body>
</html>
