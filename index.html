<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>iPhone Hand Gesture</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  overflow: hidden;
}

#status {
  position: fixed;
  top: 10px;
  left: 10px;
  color: #00ff88;
  font-family: monospace;
  z-index: 10;
}

video {
  position: fixed;
  right: 10px;
  bottom: 10px;
  width: 160px;
  opacity: 0.35;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>

<body>

<div id="status">TAP TO START</div>
<video id="video" autoplay playsinline></video>

<script>
const status = document.getElementById('status')
const video = document.getElementById('video')

let hands
let streamStarted = false

// ===== START CAMERA FIRST =====
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user' }
    })
    video.srcObject = stream
    status.innerText = 'CAMERA OK'
    startHands()
  } catch (e) {
    status.innerText = 'CAMERA ERROR'
    alert(e.message)
  }
}

// ===== INIT MEDIAPIPE =====
function startHands() {
  hands = new Hands({
    locateFile: f =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  })

  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6
  })

  hands.onResults(res => {
    if (!res.multiHandLandmarks) {
      status.innerText = 'NO HAND'
      return
    }

    const lm = res.multiHandLandmarks[0]
    const thumb = lm[4]
    const index = lm[8]

    const pinch = Math.hypot(
      thumb.x - index.x,
      thumb.y - index.y
    )

    if (pinch < 0.06) {
      status.innerText = 'ðŸ¤ PINCH'
    } else {
      status.innerText = 'âœ‹ HAND'
    }
  })

  processFrame()
}

// ===== PROCESS LOOP =====
async function processFrame() {
  if (!hands) return
  await hands.send({ image: video })
  requestAnimationFrame(processFrame)
}

// ===== iOS USER GESTURE =====
document.body.addEventListener('click', () => {
  if (!streamStarted) {
    streamStarted = true
    status.innerText = 'STARTINGâ€¦'
    startCamera()
  }
}, { once: true })
</script>

</body>
</html>
