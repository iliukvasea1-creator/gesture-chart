<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">

<title>Gesture Crypto Chart</title>

<!-- iPhone REQUIRED -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #0e0e0e;
  overflow: hidden;
  touch-action: none;
}

canvas {
  display: block;
}

video {
  position: fixed;
  right: 10px;
  bottom: 10px;
  width: 120px;
  opacity: 0.15;
  z-index: 10;
  pointer-events: none;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById('video')
const canvas = document.getElementById('canvas')
const ctx = canvas.getContext('2d')

function resize(){
  canvas.width = window.innerWidth
  canvas.height = window.innerHeight
}
resize()
window.addEventListener('resize', resize)

// ===== MOCK DATA =====
const data = Array.from({length: 300}, (_, i) =>
  300 + Math.sin(i / 10) * 60
)

let offsetX = canvas.width / 2
let scale = 1
const levels = []

// ===== DRAW =====
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height)

  // chart
  ctx.strokeStyle = '#4ade80'
  ctx.lineWidth = 2
  ctx.beginPath()

  data.forEach((p,i)=>{
    const x = i * 6 * scale + offsetX
    const y = canvas.height - p
    if(i===0) ctx.moveTo(x,y)
    else ctx.lineTo(x,y)
  })
  ctx.stroke()

  // levels
  ctx.setLineDash([6,6])
  ctx.strokeStyle = '#facc15'
  levels.forEach(y=>{
    ctx.beginPath()
    ctx.moveTo(0,y)
    ctx.lineTo(canvas.width,y)
    ctx.stroke()
  })
  ctx.setLineDash([])
}

// ===== GESTURE LOGIC =====
function detectGesture(lm){
  const thumb = lm[4]
  const index = lm[8]
  const middle = lm[12]

  const pinch = Math.hypot(
    thumb.x - index.x,
    thumb.y - index.y
  )

  if (pinch < 0.035) return 'PINCH'
  if (Math.abs(index.y - middle.y) < 0.03) return 'ZOOM'
  if (index.y < lm[6].y) return 'PAN'
  return null
}

let lastPinch = 0

// ===== MEDIAPIPE =====
const hands = new Hands({
  locateFile: f =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
})

hands.setOptions({
  maxNumHands: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
})

hands.onResults(res=>{
  if(!res.multiHandLandmarks) return

  const lm = res.multiHandLandmarks[0]
  const g = detectGesture(lm)

  if(g === 'PAN'){
    offsetX += (lm[0].x - 0.5) * 30
  }

  if(g === 'ZOOM'){
    scale += (lm[8].y - lm[12].y) * 0.08
    scale = Math.max(0.3, Math.min(scale, 5))
  }

  if(g === 'PINCH'){
    const now = Date.now()
    if(now - lastPinch > 500){
      const y = lm[8].y * canvas.height
      levels.push(y)
      lastPinch = now

      // haptic (iPhone)
      if(navigator.vibrate) navigator.vibrate(15)
    }
  }

  draw()
})

// ===== CAMERA =====
const camera = new Camera(video,{
  onFrame: async ()=>{
    await hands.send({image: video})
  },
  width: 640,
  height: 480
})

camera.start()
draw()
</script>

</body>
</html>
